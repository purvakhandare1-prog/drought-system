<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drought Warning &amp; Tanker Management</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&amp;family=Orbitron:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Rajdhani', sans-serif; }
    .orbitron { font-family: 'Orbitron', sans-serif; }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }
    
    @keyframes scan-line {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }
    
    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .animate-scan { animation: scan-line 3s linear infinite; }
    .animate-fade-in { animation: fade-in-up 0.5s ease-out forwards; }
    
    .risk-high { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
    .risk-moderate { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .risk-safe { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    
    .glass-card {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(56, 189, 248, 0.2);
    }
    
    .map-container {
      background: 
        radial-gradient(circle at 20% 30%, rgba(56, 189, 248, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    .village-dot {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .village-dot:hover {
      transform: scale(1.5);
      z-index: 100;
    }
    
    .tanker-icon {
      filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.5));
    }
    
    input[type="range"] {
      -webkit-appearance: none;
      background: transparent;
    }
    
    input[type="range"]::-webkit-slider-track {
      height: 8px;
      background: linear-gradient(90deg, #10b981, #f59e0b, #dc2626);
      border-radius: 4px;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #38bdf8;
      border-radius: 50%;
      margin-top: -6px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }
    
    .scroll-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .scroll-container::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
    }
    
    .scroll-container::-webkit-scrollbar-thumb {
      background: #38bdf8;
      border-radius: 3px;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-slate-900 text-white overflow-auto">
  <div id="app" class="min-h-full w-full"><!-- Header -->
   <header class="glass-card border-b border-cyan-500/30 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
     <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
        </svg>
       </div>
       <div>
        <h1 id="main-title" class="orbitron text-xl md:text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">Drought Warning System</h1>
        <p id="district-subtitle" class="text-cyan-400/70 text-sm">District Command Center</p>
       </div>
      </div>
      <div class="flex items-center gap-3">
       <div class="px-4 py-2 rounded-lg bg-cyan-500/10 border border-cyan-500/30"><span class="text-cyan-400 text-sm">üõ∞Ô∏è Live Monitoring</span>
       </div>
       <div id="current-time" class="orbitron text-cyan-400 text-sm"></div>
      </div>
     </div>
    </div>
   </header><!-- Stats Overview -->
   <section class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
     <div class="glass-card rounded-xl p-4 animate-fade-in" style="animation-delay: 0.1s">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center"><span class="text-2xl">üî¥</span>
       </div>
       <div>
        <p class="text-slate-400 text-xs uppercase tracking-wider">High Risk</p>
        <p id="stat-high" class="orbitron text-2xl font-bold text-red-400">0</p>
       </div>
      </div>
     </div>
     <div class="glass-card rounded-xl p-4 animate-fade-in" style="animation-delay: 0.2s">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center"><span class="text-2xl">üü°</span>
       </div>
       <div>
        <p class="text-slate-400 text-xs uppercase tracking-wider">Moderate</p>
        <p id="stat-moderate" class="orbitron text-2xl font-bold text-amber-400">0</p>
       </div>
      </div>
     </div>
     <div class="glass-card rounded-xl p-4 animate-fade-in" style="animation-delay: 0.3s">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center"><span class="text-2xl">üü¢</span>
       </div>
       <div>
        <p class="text-slate-400 text-xs uppercase tracking-wider">Safe</p>
        <p id="stat-safe" class="orbitron text-2xl font-bold text-emerald-400">0</p>
       </div>
      </div>
     </div>
     <div class="glass-card rounded-xl p-4 animate-fade-in" style="animation-delay: 0.4s">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center"><span class="text-2xl">üöõ</span>
       </div>
       <div>
        <p class="text-slate-400 text-xs uppercase tracking-wider">Tankers Needed</p>
        <p id="stat-tankers" class="orbitron text-2xl font-bold text-cyan-400">0</p>
       </div>
      </div>
     </div>
    </div>
   </section><!-- Main Content Grid -->
   <section class="max-w-7xl mx-auto px-4 pb-6">
    <div class="grid lg:grid-cols-3 gap-6"><!-- Map View -->
     <div class="lg:col-span-2 glass-card rounded-2xl overflow-hidden">
      <div class="p-4 border-b border-cyan-500/20 flex items-center justify-between">
       <h2 class="orbitron text-lg font-semibold text-cyan-400">üìç District Map View</h2>
       <div class="flex gap-2 text-xs"><span class="px-2 py-1 rounded bg-red-500/20 text-red-400">‚óè High Risk</span> <span class="px-2 py-1 rounded bg-amber-500/20 text-amber-400">‚óè Moderate</span> <span class="px-2 py-1 rounded bg-emerald-500/20 text-emerald-400">‚óè Safe</span>
       </div>
      </div>
      <div id="map-area" class="map-container relative h-80 md:h-96 overflow-hidden"><!-- Scan effect -->
       <div class="absolute inset-0 pointer-events-none opacity-20">
        <div class="w-full h-1 bg-gradient-to-r from-transparent via-cyan-400 to-transparent animate-scan"></div>
       </div><!-- Grid lines -->
       <svg class="absolute inset-0 w-full h-full opacity-10"><defs>
         <pattern id="grid" width="40" height="40" patternunits="userSpaceOnUse">
          <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#38bdf8" stroke-width="0.5" />
         </pattern>
        </defs> <rect width="100%" height="100%" fill="url(#grid)" />
       </svg><!-- Villages will be rendered here -->
       <div id="map-villages" class="absolute inset-0"></div><!-- Empty state -->
       <div id="map-empty" class="absolute inset-0 flex items-center justify-center">
        <div class="text-center">
         <div class="text-6xl mb-4">
          üó∫Ô∏è
         </div>
         <p class="text-slate-400">Add villages to see them on the map</p>
        </div>
       </div>
      </div>
     </div><!-- Add Village Form -->
     <div class="glass-card rounded-2xl overflow-hidden">
      <div class="p-4 border-b border-cyan-500/20">
       <h2 class="orbitron text-lg font-semibold text-cyan-400">‚ûï Add Village Data</h2>
      </div>
      <div class="p-4 space-y-4 scroll-container max-h-96 overflow-y-auto">
       <div><label class="block text-slate-400 text-sm mb-2">Village Name</label> <input type="text" id="input-village" placeholder="e.g., Rampur" class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-600 focus:border-cyan-500 focus:outline-none text-white placeholder-slate-500">
       </div>
       <div><label class="block text-slate-400 text-sm mb-2"> Rainfall: <span id="rainfall-value" class="text-cyan-400">50%</span> </label> <input type="range" id="input-rainfall" min="0" max="100" value="50" class="w-full">
        <div class="flex justify-between text-xs text-slate-500 mt-1"><span>0% (Drought)</span> <span>100% (Normal)</span>
        </div>
       </div>
       <div><label class="block text-slate-400 text-sm mb-2"> Groundwater Drop: <span id="groundwater-value" class="text-amber-400">30%</span> </label> <input type="range" id="input-groundwater" min="0" max="100" value="30" class="w-full">
        <div class="flex justify-between text-xs text-slate-500 mt-1"><span>0% (Stable)</span> <span>100% (Critical)</span>
        </div>
       </div>
       <div><label class="block text-slate-400 text-sm mb-2">Population</label> <input type="number" id="input-population" placeholder="e.g., 5000" min="100" class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-600 focus:border-cyan-500 focus:outline-none text-white placeholder-slate-500">
       </div><!-- Preview -->
       <div id="preview-box" class="p-4 rounded-lg bg-slate-800/30 border border-slate-700">
        <p class="text-slate-400 text-sm mb-2">Water Stress Preview:</p>
        <div class="flex items-center gap-3">
         <div id="preview-score" class="orbitron text-3xl font-bold text-cyan-400">
          --
         </div>
         <div><span id="preview-risk" class="px-3 py-1 rounded-full text-sm font-semibold bg-slate-700 text-slate-400"> Enter Data </span>
         </div>
        </div>
        <div id="preview-tankers" class="mt-2 text-sm text-slate-400">
         Tankers needed: <span class="text-cyan-400">--</span>
        </div>
       </div><button id="btn-add" class="w-full py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-semibold hover:from-cyan-400 hover:to-blue-500 transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"> <span>‚ûï</span> Add Village </button>
       <div id="limit-warning" class="hidden p-3 rounded-lg bg-red-500/20 border border-red-500/30 text-red-400 text-sm text-center">
        ‚ö†Ô∏è Maximum 999 villages reached
       </div>
      </div>
     </div>
    </div>
   </section><!-- Villages List & Tanker Allocation -->
   <section class="max-w-7xl mx-auto px-4 pb-6">
    <div class="grid lg:grid-cols-2 gap-6"><!-- Priority Queue -->
     <div class="glass-card rounded-2xl overflow-hidden">
      <div class="p-4 border-b border-cyan-500/20 flex items-center justify-between">
       <h2 class="orbitron text-lg font-semibold text-cyan-400">üö® Priority Queue</h2><span class="text-xs text-slate-400">Sorted by urgency</span>
      </div>
      <div id="priority-list" class="p-4 space-y-3 scroll-container max-h-80 overflow-y-auto">
       <div class="text-center py-8 text-slate-500">
        <div class="text-4xl mb-2">
         üìã
        </div>
        <p>No villages added yet</p>
       </div>
      </div>
     </div><!-- Tanker Dispatch -->
     <div class="glass-card rounded-2xl overflow-hidden">
      <div class="p-4 border-b border-cyan-500/20 flex items-center justify-between">
       <h2 class="orbitron text-lg font-semibold text-cyan-400">üöõ Smart Tanker Dispatch</h2><button id="btn-dispatch" class="px-4 py-2 rounded-lg bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500/30 transition-all text-sm disabled:opacity-50"> Generate Route </button>
      </div>
      <div id="dispatch-info" class="p-4">
       <div class="grid grid-cols-3 gap-4 mb-4">
        <div class="text-center p-3 rounded-lg bg-slate-800/50">
         <p class="text-slate-400 text-xs">Total Distance</p>
         <p id="total-distance" class="orbitron text-xl text-cyan-400">-- km</p>
        </div>
        <div class="text-center p-3 rounded-lg bg-slate-800/50">
         <p class="text-slate-400 text-xs">Est. Time</p>
         <p id="total-time" class="orbitron text-xl text-amber-400">-- hrs</p>
        </div>
        <div class="text-center p-3 rounded-lg bg-slate-800/50">
         <p class="text-slate-400 text-xs">Fuel Est.</p>
         <p id="total-fuel" class="orbitron text-xl text-emerald-400">-- L</p>
        </div>
       </div>
       <div id="route-list" class="space-y-2 scroll-container max-h-48 overflow-y-auto">
        <div class="text-center py-4 text-slate-500 text-sm">
         Click "Generate Route" to optimize tanker dispatch
        </div>
       </div>
      </div>
     </div>
    </div>
   </section><!-- Formula Explanation -->
   <section class="max-w-7xl mx-auto px-4 pb-6">
    <div class="glass-card rounded-2xl p-6">
     <h2 class="orbitron text-lg font-semibold text-cyan-400 mb-4">üìä How Water Stress Index Works</h2>
     <div class="grid md:grid-cols-3 gap-6">
      <div class="p-4 rounded-lg bg-slate-800/30">
       <div class="text-3xl mb-2">
        üåßÔ∏è
       </div>
       <h3 class="font-semibold text-white mb-1">Rainfall Factor</h3>
       <p class="text-slate-400 text-sm">100 - Rainfall% = Drought severity. Lower rainfall = higher stress.</p><code class="text-cyan-400 text-xs mt-2 block">(100 - rainfall) √ó 0.4</code>
      </div>
      <div class="p-4 rounded-lg bg-slate-800/30">
       <div class="text-3xl mb-2">
        üíß
       </div>
       <h3 class="font-semibold text-white mb-1">Groundwater Factor</h3>
       <p class="text-slate-400 text-sm">Direct measure of water table drop. Higher drop = more critical.</p><code class="text-cyan-400 text-xs mt-2 block">groundwater_drop √ó 0.4</code>
      </div>
      <div class="p-4 rounded-lg bg-slate-800/30">
       <div class="text-3xl mb-2">
        üë•
       </div>
       <h3 class="font-semibold text-white mb-1">Population Factor</h3>
       <p class="text-slate-400 text-sm">More people = more water demand. Logarithmic scale for fairness.</p><code class="text-cyan-400 text-xs mt-2 block">log10(population) √ó 5</code>
      </div>
     </div>
     <div class="mt-6 p-4 rounded-lg bg-cyan-500/10 border border-cyan-500/20">
      <p class="text-center"><span class="text-slate-400">Final Score:</span> <span class="orbitron text-cyan-400 ml-2">WSI = Rainfall Factor + Groundwater Factor + Population Factor</span></p>
      <div class="flex justify-center gap-6 mt-3 text-sm"><span class="text-emerald-400">0-50: Safe üü¢</span> <span class="text-amber-400">50-100: Moderate üü°</span> <span class="text-red-400">100+: High Risk üî¥</span>
      </div>
     </div>
    </div>
   </section>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      dashboard_title: 'Drought Warning System',
      district_name: 'District Command Center',
      background_color: '#0f172a',
      surface_color: '#1e293b',
      text_color: '#e2e8f0',
      primary_action_color: '#06b6d4',
      secondary_action_color: '#10b981',
      font_family: 'Rajdhani',
      font_size: 16
    };

    let config = { ...defaultConfig };
    let villageData = [];
    let currentRecordCount = 0;

    // Calculate Water Stress Index
    function calculateWSI(rainfall, groundwater, population) {
      const rainfallFactor = (100 - rainfall) * 0.4;
      const groundwaterFactor = groundwater * 0.4;
      const populationFactor = Math.log10(Math.max(population, 100)) * 5;
      return Math.round(rainfallFactor + groundwaterFactor + populationFactor);
    }

    // Get risk level from WSI
    function getRiskLevel(wsi) {
      if (wsi >= 100) return { level: 'HIGH', color: 'red', tankers: 3, emoji: 'üî¥' };
      if (wsi >= 50) return { level: 'MODERATE', color: 'amber', tankers: 2, emoji: 'üü°' };
      return { level: 'SAFE', color: 'emerald', tankers: 0, emoji: 'üü¢' };
    }

    // Update preview as user inputs data
    function updatePreview() {
      const rainfall = parseInt(document.getElementById('input-rainfall').value);
      const groundwater = parseInt(document.getElementById('input-groundwater').value);
      const population = parseInt(document.getElementById('input-population').value) || 1000;

      document.getElementById('rainfall-value').textContent = rainfall + '%';
      document.getElementById('groundwater-value').textContent = groundwater + '%';

      const wsi = calculateWSI(rainfall, groundwater, population);
      const risk = getRiskLevel(wsi);

      document.getElementById('preview-score').textContent = wsi;
      document.getElementById('preview-score').className = `orbitron text-3xl font-bold text-${risk.color}-400`;
      
      const riskBadge = document.getElementById('preview-risk');
      riskBadge.textContent = `${risk.emoji} ${risk.level}`;
      riskBadge.className = `px-3 py-1 rounded-full text-sm font-semibold bg-${risk.color}-500/20 text-${risk.color}-400`;
      
      document.getElementById('preview-tankers').innerHTML = 
        `Tankers needed: <span class="text-${risk.color}-400">${risk.tankers}</span>`;
    }

    // Update time display
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-IN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // Render map with villages
    function renderMap() {
      const mapArea = document.getElementById('map-villages');
      const emptyState = document.getElementById('map-empty');
      
      if (villageData.length === 0) {
        mapArea.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      mapArea.innerHTML = '';
      
      villageData.forEach((village, index) => {
        const risk = getRiskLevel(village.water_stress_score);
        const dot = document.createElement('div');
        dot.className = `village-dot absolute flex flex-col items-center`;
        dot.style.left = `${village.lat}%`;
        dot.style.top = `${village.lng}%`;
        dot.style.animationDelay = `${index * 0.1}s`;
        
        const colorMap = { red: '#ef4444', amber: '#f59e0b', emerald: '#10b981' };
        
        dot.innerHTML = `
          <div class="relative">
            <div class="w-4 h-4 rounded-full animate-pulse-glow" 
                 style="background: ${colorMap[risk.color]}; color: ${colorMap[risk.color]}">
            </div>
            <div class="absolute -inset-2 rounded-full opacity-30 animate-ping"
                 style="background: ${colorMap[risk.color]}"></div>
          </div>
          <div class="mt-1 px-2 py-0.5 rounded text-xs bg-slate-900/80 text-white whitespace-nowrap">
            ${village.village_name}
          </div>
        `;
        
        dot.onclick = () => showVillageDetails(village);
        mapArea.appendChild(dot);
      });
    }

    // Show village details (inline tooltip style)
    function showVillageDetails(village) {
      const risk = getRiskLevel(village.water_stress_score);
      const existingTooltip = document.querySelector('.village-tooltip');
      if (existingTooltip) existingTooltip.remove();
      
      const tooltip = document.createElement('div');
      tooltip.className = 'village-tooltip fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 glass-card rounded-xl p-4 min-w-64';
      tooltip.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <h3 class="orbitron text-lg font-bold text-cyan-400">${village.village_name}</h3>
          <button onclick="this.parentElement.parentElement.remove()" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <div class="space-y-2 text-sm">
          <p><span class="text-slate-400">WSI Score:</span> <span class="orbitron text-${risk.color}-400">${village.water_stress_score}</span></p>
          <p><span class="text-slate-400">Risk Level:</span> <span class="text-${risk.color}-400">${risk.emoji} ${risk.level}</span></p>
          <p><span class="text-slate-400">Rainfall:</span> ${village.rainfall_percent}%</p>
          <p><span class="text-slate-400">Groundwater Drop:</span> ${village.groundwater_drop}%</p>
          <p><span class="text-slate-400">Population:</span> ${village.population.toLocaleString()}</p>
          <p><span class="text-slate-400">Tankers Needed:</span> ${village.tankers_needed}</p>
        </div>
        <button onclick="deleteVillage('${village.__backendId}'); this.parentElement.remove();" 
                class="mt-3 w-full py-2 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 text-sm">
          üóëÔ∏è Remove Village
        </button>
      `;
      document.body.appendChild(tooltip);
    }

    // Update statistics
    function updateStats() {
      let high = 0, moderate = 0, safe = 0, totalTankers = 0;
      
      villageData.forEach(v => {
        const risk = getRiskLevel(v.water_stress_score);
        if (risk.level === 'HIGH') high++;
        else if (risk.level === 'MODERATE') moderate++;
        else safe++;
        totalTankers += v.tankers_needed;
      });
      
      document.getElementById('stat-high').textContent = high;
      document.getElementById('stat-moderate').textContent = moderate;
      document.getElementById('stat-safe').textContent = safe;
      document.getElementById('stat-tankers').textContent = totalTankers;
    }

    // Render priority list
    function renderPriorityList() {
      const container = document.getElementById('priority-list');
      
      if (villageData.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-slate-500">
            <div class="text-4xl mb-2">üìã</div>
            <p>No villages added yet</p>
          </div>
        `;
        return;
      }
      
      // Sort by WSI descending (highest risk first)
      const sorted = [...villageData].sort((a, b) => b.water_stress_score - a.water_stress_score);
      
      container.innerHTML = sorted.map((village, index) => {
        const risk = getRiskLevel(village.water_stress_score);
        const colorMap = { red: 'red', amber: 'amber', emerald: 'emerald' };
        
        return `
          <div class="flex items-center gap-3 p-3 rounded-lg bg-${colorMap[risk.color]}-500/10 border border-${colorMap[risk.color]}-500/20 animate-fade-in" style="animation-delay: ${index * 0.05}s">
            <div class="w-8 h-8 rounded-full bg-${colorMap[risk.color]}-500/20 flex items-center justify-center text-${colorMap[risk.color]}-400 font-bold">
              ${index + 1}
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-semibold text-white truncate">${village.village_name}</p>
              <p class="text-xs text-slate-400">Pop: ${village.population.toLocaleString()} | üöõ ${village.tankers_needed}</p>
            </div>
            <div class="text-right">
              <p class="orbitron text-lg font-bold text-${colorMap[risk.color]}-400">${village.water_stress_score}</p>
              <p class="text-xs text-${colorMap[risk.color]}-400">${risk.emoji} ${risk.level}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // Generate optimized route
    function generateRoute() {
      if (villageData.length === 0) return;
      
      // Sort by WSI and create route
      const sorted = [...villageData]
        .filter(v => v.tankers_needed > 0)
        .sort((a, b) => b.water_stress_score - a.water_stress_score);
      
      if (sorted.length === 0) {
        document.getElementById('route-list').innerHTML = `
          <div class="text-center py-4 text-emerald-400">
            ‚úÖ All villages are safe! No tankers needed.
          </div>
        `;
        document.getElementById('total-distance').textContent = '0 km';
        document.getElementById('total-time').textContent = '0 hrs';
        document.getElementById('total-fuel').textContent = '0 L';
        return;
      }
      
      // Calculate estimates (simulated)
      let totalDistance = 0;
      sorted.forEach((v, i) => {
        totalDistance += Math.round(10 + Math.random() * 20); // Random 10-30km per village
      });
      
      const totalTime = (totalDistance / 30).toFixed(1); // 30 km/h average
      const totalFuel = Math.round(totalDistance * 0.4); // 0.4 L/km
      
      document.getElementById('total-distance').textContent = totalDistance + ' km';
      document.getElementById('total-time').textContent = totalTime + ' hrs';
      document.getElementById('total-fuel').textContent = totalFuel + ' L';
      
      document.getElementById('route-list').innerHTML = sorted.map((village, index) => {
        const risk = getRiskLevel(village.water_stress_score);
        return `
          <div class="flex items-center gap-2 p-2 rounded bg-slate-800/50 text-sm">
            <span class="w-6 h-6 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-400 text-xs font-bold">
              ${index + 1}
            </span>
            <span class="flex-1 truncate">${village.village_name}</span>
            <span class="text-${risk.color}-400">${village.tankers_needed} üöõ</span>
          </div>
        `;
      }).join('');
    }

    // Delete village
    async function deleteVillage(backendId) {
      const village = villageData.find(v => v.__backendId === backendId);
      if (!village) return;
      
      const result = await window.dataSdk.delete(village);
      if (!result.isOk) {
        console.error('Failed to delete village:', result.error);
      }
    }

    // Add new village
    async function addVillage() {
      if (currentRecordCount >= 999) {
        document.getElementById('limit-warning').classList.remove('hidden');
        return;
      }
      
      const villageName = document.getElementById('input-village').value.trim();
      const rainfall = parseInt(document.getElementById('input-rainfall').value);
      const groundwater = parseInt(document.getElementById('input-groundwater').value);
      const population = parseInt(document.getElementById('input-population').value);
      
      if (!villageName || !population) {
        // Show inline error
        const btn = document.getElementById('btn-add');
        btn.textContent = '‚ö†Ô∏è Please fill all fields';
        btn.classList.add('bg-red-500');
        setTimeout(() => {
          btn.innerHTML = '<span>‚ûï</span> Add Village';
          btn.classList.remove('bg-red-500');
        }, 2000);
        return;
      }
      
      const wsi = calculateWSI(rainfall, groundwater, population);
      const risk = getRiskLevel(wsi);
      
      const newVillage = {
        village_name: villageName,
        rainfall_percent: rainfall,
        groundwater_drop: groundwater,
        population: population,
        water_stress_score: wsi,
        risk_level: risk.level,
        tankers_needed: risk.tankers,
        lat: 10 + Math.random() * 80, // Random position for demo
        lng: 10 + Math.random() * 80,
        created_at: new Date().toISOString()
      };
      
      const btn = document.getElementById('btn-add');
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin">‚è≥</span> Adding...';
      
      const result = await window.dataSdk.create(newVillage);
      
      if (result.isOk) {
        // Clear form
        document.getElementById('input-village').value = '';
        document.getElementById('input-rainfall').value = 50;
        document.getElementById('input-groundwater').value = 30;
        document.getElementById('input-population').value = '';
        updatePreview();
        btn.innerHTML = '<span>‚úÖ</span> Added!';
        setTimeout(() => {
          btn.innerHTML = '<span>‚ûï</span> Add Village';
        }, 1500);
      } else {
        btn.innerHTML = '<span>‚ùå</span> Failed';
        setTimeout(() => {
          btn.innerHTML = '<span>‚ûï</span> Add Village';
        }, 2000);
      }
      
      btn.disabled = false;
    }

    // Data handler for SDK
    const dataHandler = {
      onDataChanged(data) {
        villageData = data;
        currentRecordCount = data.length;
        
        // Update limit warning
        if (currentRecordCount >= 999) {
          document.getElementById('limit-warning').classList.remove('hidden');
        } else {
          document.getElementById('limit-warning').classList.add('hidden');
        }
        
        updateStats();
        renderMap();
        renderPriorityList();
      }
    };

    // Apply config changes
    async function onConfigChange(cfg) {
      config = { ...defaultConfig, ...cfg };
      
      document.getElementById('main-title').textContent = config.dashboard_title;
      document.getElementById('district-subtitle').textContent = config.district_name;
      
      // Apply font
      document.body.style.fontFamily = `${config.font_family}, Rajdhani, sans-serif`;
      
      // Apply font size scaling
      const baseSize = config.font_size;
      document.querySelectorAll('.orbitron').forEach(el => {
        if (el.classList.contains('text-2xl')) {
          el.style.fontSize = `${baseSize * 1.5}px`;
        } else if (el.classList.contains('text-xl')) {
          el.style.fontSize = `${baseSize * 1.25}px`;
        } else if (el.classList.contains('text-lg')) {
          el.style.fontSize = `${baseSize * 1.125}px`;
        }
      });
    }

    // Initialize everything
    async function init() {
      // Update time
      updateTime();
      setInterval(updateTime, 1000);
      
      // Setup event listeners
      document.getElementById('input-rainfall').addEventListener('input', updatePreview);
      document.getElementById('input-groundwater').addEventListener('input', updatePreview);
      document.getElementById('input-population').addEventListener('input', updatePreview);
      document.getElementById('btn-add').addEventListener('click', addVillage);
      document.getElementById('btn-dispatch').addEventListener('click', generateRoute);
      
      updatePreview();
      
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.background_color || defaultConfig.background_color,
                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
              },
              {
                get: () => cfg.surface_color || defaultConfig.surface_color,
                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
              },
              {
                get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                set: (v) => { cfg.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); }
              },
              {
                get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                set: (v) => { cfg.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => cfg.font_family || defaultConfig.font_family,
              set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
            },
            fontSizeable: {
              get: () => cfg.font_size || defaultConfig.font_size,
              set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
            }
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['dashboard_title', cfg.dashboard_title || defaultConfig.dashboard_title],
            ['district_name', cfg.district_name || defaultConfig.district_name]
          ])
        });
      }
      
      // Initialize Data SDK
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK:', result.error);
        }
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d26516a42803b04',t:'MTc3MTg0NTQ2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>